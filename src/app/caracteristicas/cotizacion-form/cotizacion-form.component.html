<div class="container">
    <div class="cotizacion-form-container">
        <h1>Cotización de Motocicletas Italika</h1>
    </div>
    <div *ngIf="errorMessage" class="alert alert-danger">
        {{ errorMessage }}
    </div>
    <form [formGroup]="cotizacionForm" (ngSubmit)="onSubmit()">
        <div class="form-section">
            <h2>Selecciona tu Motocicleta</h2>
            <div class="form-group">
                <label for="version">Modelo y Versión *</label>
                <select name="version" id="version" formControlName="idVersion" class="form-control">
                    <option>Selecciona una version</option>
                    <option *ngFor="let version of versiones" [value]="version.idVersion">
                        {{ version.marca }} {{ version.modeloNombre }} - {{ version.nombreVersion }} 
                        ({{ version.anio }}) - ${{ version.precioBase | number:'1.2-2' }}
                    </option>
                </select>
                <div *ngIf="cotizacionForm.get('idVersion')?.invalid && cotizacionForm.get('idVersion')?.touched" 
               class="error-message">
            Selecciona una versión
          </div>
        </div>
        <div *ngIf="versionSeleccionada" class="moto-info">
          <h3>{{ versionSeleccionada.marca }} {{ versionSeleccionada.modeloNombre }}</h3>
          <p class="version-name">{{ versionSeleccionada.nombreVersion }}</p>
          <p class="precio-base">Precio Base: ${{ versionSeleccionada.precioBase | number:'1.2-2' }}</p>
          <p *ngIf="versionSeleccionada.descripcion">{{ versionSeleccionada.descripcion }}</p>
        </div>
      </div>
      <div class="form-section" formGroupName="cliente">
        <h2>Datos del Cliente</h2>
        <div class="form-group">
          <label for="nombre">Nombre Completo *</label>
          <input type="text" id="nombre" formControlName="nombre" class="form-control" 
                 placeholder="Ej: Juan Pérez García">
          <div *ngIf="cotizacionForm.get('cliente.nombre')?.invalid && cotizacionForm.get('cliente.nombre')?.touched" 
               class="error-message">
            El nombre es requerido
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col-md-6">
            <label for="telefono">Teléfono *</label>
            <input type="tel" id="telefono" formControlName="telefono" class="form-control" 
                   placeholder="5512345678" maxlength="10">
            <div *ngIf="cotizacionForm.get('cliente.telefono')?.invalid && cotizacionForm.get('cliente.telefono')?.touched" 
                 class="error-message">
              Ingresa un teléfono válido (10 dígitos)
            </div>
          </div>
          <div class="form-group col-md-6">
            <label for="email">Correo Electrónico *</label>
            <input type="email" id="email" formControlName="email" class="form-control" 
                   placeholder="correo@ejemplo.com">
            <div *ngIf="cotizacionForm.get('cliente.email')?.invalid && cotizacionForm.get('cliente.email')?.touched" 
                 class="error-message">
              Ingresa un correo válido
            </div>
          </div>
        </div>
      </div>
      <div class="form-section">
        <h2>Costos Adicionales</h2>
        <div class="form-row">
          <div class="form-group col-md-4">
            <label for="enganche">Enganche (mínimo 10%) *</label>
            <input type="number" id="enganche" formControlName="montoEnganche" 
                   class="form-control" step="0.01">
            <small *ngIf="versionSeleccionada" class="form-text">
              Mínimo: ${{ (versionSeleccionada.precioBase * 0.10) | number:'1.2-2' }}
            </small>
            <div *ngIf="!validarEnganche() && cotizacionForm.get('montoEnganche')?.touched" 
                 class="error-message">
              El enganche debe ser al menos el 10%
            </div>
          </div>
          <div class="form-group col-md-4">
            <label for="gastosAdmin">Gastos Administrativos *</label>
            <input type="number" id="gastosAdmin" formControlName="gastosAdministrativos" 
                   class="form-control" step="0.01">
          </div>

          <div class="form-group col-md-4">
            <label for="seguro">Seguro de Vehículo *</label>
            <input type="number" id="seguro" formControlName="costoSeguro" 
                   class="form-control" step="0.01">
          </div>
        </div>
      </div>
      <div class="form-section">
        <h2>Accesorios Opcionales</h2>
        <div class="accesorios-selector">
          <label>Agregar Accesorio:</label>
          <div class="accesorio-buttons">
            <button *ngFor="let accesorio of accesorios" 
                    type="button" 
                    class="btn btn-outline-secondary btn-sm"
                    (click)="agregarAccesorio(accesorio)">
              {{ accesorio.nombre }} - ${{ accesorio.precio | number:'1.2-2' }}
            </button>
          </div>
        </div>
        <div *ngIf="accesoriosFormArray.length > 0" class="accesorios-seleccionados">
          <h3>Accesorios Seleccionados</h3>
          <table class="table">
            <thead>
              <tr>
                <th>Accesorio</th>
                <th>Precio Unitario</th>
                <th>Cantidad</th>
                <th>Subtotal</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody formArrayName="accesoriosSeleccionados">
              <tr *ngFor="let accesorio of accesoriosFormArray.controls; let i = index" [formGroupName]="i">
                <td>{{ accesorio.get('nombre')?.value }}</td>
                <td>${{ accesorio.get('precio')?.value | number:'1.2-2' }}</td>
                <td>
                  <input type="number" formControlName="cantidad" class="form-control" 
                         min="1" style="width: 80px;">
                </td>
                <td>${{ (accesorio.get('precio')?.value * accesorio.get('cantidad')?.value) | number:'1.2-2' }}</td>
                <td>
                  <button type="button" class="btn btn-danger btn-sm" (click)="eliminarAccesorio(i)">
                    Eliminar
                  </button>
                </td>
              </tr>
            </tbody>
            <tfoot>
              <tr>
                <td colspan="3"><strong>Total Accesorios:</strong></td>
                <td colspan="2"><strong>${{ calcularTotalAccesorios() | number:'1.2-2' }}</strong></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
      <div class="form-section resumen" *ngIf="versionSeleccionada">
        <h2>Resumen</h2>
        <div class="resumen-content">
          <div class="resumen-item">
            <span>Costo Total Estimado:</span>
            <span class="resumen-valor">${{ calcularCostoTotal() | number:'1.2-2' }}</span>
          </div>
          <div class="resumen-item">
            <span>Enganche:</span>
            <span class="resumen-valor">${{ cotizacionForm.get('montoEnganche')?.value | number:'1.2-2' }}</span>
          </div>
          <div class="resumen-item">
            <span>Monto a Financiar:</span>
            <span class="resumen-valor">
              ${{ (calcularCostoTotal() - (cotizacionForm.get('montoEnganche')?.value || 0)) | number:'1.2-2' }}
            </span>
          </div>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="resetForm()" [disabled]="loading">
          Limpiar
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="loading || cotizacionForm.invalid">
          <span *ngIf="!loading">Generar Cotización</span>
          <span *ngIf="loading">Procesando...</span>
        </button>
        </div>
    </form>
</div>
